name: Amplify Maintenance Toggle (OIDC)

on:
  workflow_dispatch:
    inputs:
      maintenance:
        description: "Enable maintenance mode?"
        required: true
        type: choice
        options:
          - "true"
          - "false"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-south-1
  APP_ID: dtp7k5k7ei8si
  BRANCH: main
  MAINTENANCE_URL: https://maintance-window-test.s3.ap-south-1.amazonaws.com/maintance-windows/index.html

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::235351028312:role/Github-token
          aws-region: ${{ env.AWS_REGION }}

      - name: Toggle maintenance mode
        run: |
          echo "Maintenance flag: ${{ inputs.maintenance }}"

          if [ "${{ inputs.maintenance }}" = "true" ]; then
            echo "ðŸ”´ Enabling maintenance mode (S3 redirect)"

            aws amplify update-app \
              --app-id $APP_ID \
              --custom-rules '[
                {
                  "source": "/*",
                  "target": "'"$MAINTENANCE_URL"'",
                  "status": "302"
                }
              ]'

          else
            echo "ðŸŸ¢ Disabling maintenance mode"

            aws amplify update-app \
              --app-id $APP_ID \
              --custom-rules '[]'
          fi

      - name: Clear Amplify cache (MANDATORY)
        run: |
          echo "ðŸ§¹ Clearing Amplify cache"
          aws amplify start-job \
            --app-id $APP_ID \
            --branch-name $BRANCH \
            --job-type RELEASE
