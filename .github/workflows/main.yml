name: Amplify Maintenance Toggle (OIDC)

on:
  workflow_dispatch:
    inputs:
      maintenance:
        description: "Enable maintenance mode?"
        required: true
        type: choice
        options:
          - "true"
          - "false"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-south-1
  APP_ID: d3n2r1wsu6tac3
  BRANCH: main
  MAINTENANCE_URL: https://maintance-window-test.s3.ap-south-1.amazonaws.com/maintance-windows/index.html

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::235351028312:role/Github-token
          aws-region: ${{ env.AWS_REGION }}

      - name: Toggle maintenance mode
        env:
          MAINTENANCE: ${{ inputs.maintenance }}
        run: |
          set -euo pipefail
          echo "Current Maintenance Flag: ${MAINTENANCE}"

          # ---------------------------------------------------------
          # CONFIGURATION
          # ---------------------------------------------------------
          
          # 1. MAINTENANCE MODE RULE (REWRITE)
          # "status": "200" keeps the URL as example.com
          # "source": "/<*>" catches all paths
          JSON_MAINTENANCE='[
            {
              "source": "/<*>",
              "target": "'"$MAINTENANCE_URL"'",
              "status": "200"
            }
          ]'

          # 2. STANDARD PRODUCTION RULE (SPA Rewrite)
          # Restores normal routing when maintenance is OFF
          JSON_STANDARD='[
            {
              "source": "</^[^.]+$/>",
              "target": "/index.html",
              "status": "200"
            }
          ]'

          # ---------------------------------------------------------
          # EXECUTION
          # ---------------------------------------------------------
          
          if [[ "${MAINTENANCE}" == "true" ]]; then
            echo "ðŸ”´ ACTIVATE: Applying Maintenance Rewrite (Hidden URL)..."
            aws amplify update-app \
              --app-id "$APP_ID" \
              --custom-rules "$JSON_MAINTENANCE"
              
            echo "âœ… Maintenance mode ENABLED. User sees example.com"

          else
            echo "ðŸŸ¢ DEACTIVATE: Restoring Standard SPA Routing..."
            aws amplify update-app \
              --app-id "$APP_ID" \
              --custom-rules "$JSON_STANDARD"
              
            echo "âœ… Maintenance mode DISABLED. Traffic is pointing to App."
          fi

      - name: Start Amplify Release
        run: |
          echo "ðŸš€ Triggering release on branch: $BRANCH to flush cache..."
          aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH" \
            --job-type RELEASE
